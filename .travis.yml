sudo: required
language: python
python:
- '3.6'
env:
  matrix:
  - ENVIRONMENT_NAME=development
  - ENVIRONMENT_NAME=staging
  - ENVIRONMENT_NAME=production
  global:
  - secure: snUazAi/K54a7+tybck9hWLMLLNtV8/E6mvL6a5jL2pieJxngVtk7u7oBqXcscAZ4pgVVmadwcDXwVpJG9vo0T8vN/F6g7axDAvoh0x8SA8yzLojSOxu/2vJgT4M4IFyD+5D1whO3YCw5QZaufx1MVQi+FFzHhpjXFD5Ld9jYBvDqoMjKcORG4D2uefNs8xTrMOzpoOqRfad6kC4MviJld60b92scbyVqZL/UtKwR1DADY4+S4vZUT3X7O3Ypz0S9uOH5SUp7JZV/TxASiyy12rKrb8RRs7LKBA8TLk0jtgdaOggINxbewzhFZNNy07axcEaaq0K5SK6sC0oCnUGKOCq2WCQuWqZdsLOQfVY6bEXRufiTO99xJpQIgrumQVxA4mUvRp12ncaSaexWgCeSAppuUheVF3n4/GRa1ds17Cl+zUtTy+fhd4k9MyGYAenGcEXf3iVYqMGcAlKBenkizzBxRiVhoz1A1sPuGztSYi1N6R1EtdcbrFeLQd08NfcJXFo8SWX22b0nBE6qEUvCLKZYdA7cNBlme/mjg+6IOQ1/QRwGNvKNYF2gFqkr4v0h6gWF4FH2VzPA1nBoewosfeNFC5nKBUV2BWpFncXMV4h3Fpc+yKHkjRTwxh+ZZKqO9Sb2pJB37Hlowbupk/PiI6wK+3wIuqJBvQ9au7DHSw=
  - secure: a1QR89ZwqjidrHmfPsfpAt+//S+vFqHGGjQ99jW74PniD2jRy5v14ldWs8DW+06hjVvmjQb5OveTklvtzFMmv2BA5wsTdel7XVacfjUkE2th8ieQE+5Qz7QfR5ddjdd930bFDEX8Kops3QNFhXTkDC0C1Avqe1AtLY//ZRyk7EFI7Di7Pn2Rj4VO9JB3SDxccvrYtFIXggvFNH/faezvEV9OwvazkLrs5hl+TnrcOKAlQkbOIn0DojDl1shyLHM7JTthVT/NF9fHt6fdWCQMdxltbBDmDeY0xP5QuPXdlGXCmW6/wYxayLMcqwrSrPbqai4jtiyYk1qfm7vdraxJQFhD6d5vOWnXvRdqZF+6wrbV/rluiuAXAJwSQUk3WkOo/uQPyAxH3IRBqHO1c+zelbe/BjFr01qdragvsf7if82mMolLa61kh88ucQrc/UTokTXXDrAn0bXwBxI2LTTavfAiPdqVPjRwsF3adUSnIYrfLQoMxJgC/76Z2EcPQGHr52409fhbngpqttB+xgWMoJqVtHkkbRN/LO+qYF/vCzpeSr45H/sj/YbHKjx/VpSOVYqvfSBW6A/9Fsm1ObURDbcYanfDoWOIh1720HMKXDA8Z+7NgCscuJfAPmI1e6CJgRPcsKrs6qxE+609NGASFCRdKrLna5csrPmmMD5u4W0=
before_install:
- export IAM_PGP=iamjohnnym
- export REGION=us-east-1
- export PROJECT_NAME=terrvis-backend
- export AWS_DEFAULT_REGION=${REGION}
- wget https://releases.hashicorp.com/terraform/0.11.10/terraform_0.11.10_linux_amd64.zip
  -O /tmp/terraform.zip
- sudo unzip -d /usr/local/bin/ /tmp/terraform.zip
- pip install awscli
- make terrvis_backend terrvis_tfvars
- cd ./terrvis_deploy ;
- terraform init -input=false -force-copy ;
script:
- terraform plan -input=false -var-file=./environments/${ENVIRONMENT_NAME}.tfvars
jobs:
  include:
  - stage: Deploy development
    script:
    - terraform apply -auto-approve -input=false -var-file=./environments/${ENVIRONMENT_NAME}.tfvars
    env:
    - ENVIRONMENT_NAME=development
    if: branch = master
  - stage: Deploy staging
    script:
    - terraform apply -auto-approve -input=false -var-file=./environments/${ENVIRONMENT_NAME}.tfvars
    env:
    - ENVIRONMENT_NAME=staging
    if: branch = master
  - stage: Deploy Production
    script:
    - terraform apply -auto-approve -input=false -var-file=./environments/${ENVIRONMENT_NAME}.tfvars
    env:
    - ENVIRONMENT_NAME=production
    if: branch = master
notifications:
  slack:
    rooms:
      secure: NGKBSoMWDxMnUiqwFzEjH7P4JWxp2ttLIE6Xmaer1IdsuUDiMXmXJuguRS1+yFZOi4KQWQUPzJBTN9uG1kEtMljqM7GeSjbpdT63WRcunsp0lfZpnVPALJPp2MB9q0EcDs/lc4LkcLJbOMRIFusA+rY7paBCL+pmZtT/IrfcQgNP7WdTws71tASDYb7++H/x3927ynEc5K9N43eXQ3m1lUyd51mAWi/kRqhfNHpDO4d1zCgqh/eBfWVeZqR6OBF+xg2ldZZxE+IstFjmSC/ilXBjkqGGjVB+S74Gpys6HFGmXSAr91W/K5xAGSn0dwnWJJvQ6WsO8eYUcxDcHQWJPOXhT3qB7AEkN9RUP2dOIuu/fM0dXL6K1P0dL13skGEWOjalqB7n0w9Si3rmHb+jVqIowlxuVVRq2tgdtQ3uzj1735o31jZLeBscD2yw7LteC5n+4+CBvQ86YeMYgYRHBZ925YH3/2MQ+1OLO/DM3dMiz8Du4jiCGmXjBgQ6R7jmy5yEscMAD4CO2BfZlAF+6iPjQ26abwO3PDVrpEfRbyXr6z7YuSi+4O6j+81OgN9A5UXaYJs1d1soK6v+HJCz1EYne+ShsdVGWJWKrIPuEcv6J26wBP+aItKPHDN5OjGGYXplCQK8F/vk/cm4ZomMcO76XLkb0TgN4cSnHnntCbI=
    use_notice: true
    template:
    - "%{repository_slug}#%{build_number} (%{branch} - %{commit} : %{author}): %{message}"
    - 'Change view : %{compare_url}'
    - 'Build details : %{build_url}'
